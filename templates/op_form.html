{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>Nova Ordem de Produ√ß√£o</h2>

  <form method="post" action="{{ url_for('op_criar') }}">
    
    <div>
      <label style="font-weight: bold; color: #666;">Obra</label>
      <select name="obra_id" id="obra_select" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px;">
        <option value="">-- Selecione uma obra --</option>
        {% for obra in obras %}
          <option value="{{ obra.id }}">{{ obra.codigo }} - {{ obra.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label style="font-weight: bold; color: #666;">Produto</label>
      <select name="produto" id="produto_select" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px;">
        <option value="">-- Selecione um produto --</option>
      </select>
    </div>

    <div>
      <label style="font-weight: bold; color: #666;">Quantidade</label>
      <input type="number" id="quantidade_input" name="quantidade" value="1" min="1" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px;">
    </div>

    <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">

    <h3 style="color: #d97706; margin-bottom: 15px;">üîß Corte / Dobra</h3>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      <div>
        <label style="font-weight: bold; color: #666;">Data de In√≠cio</label>
        <input type="date" id="corte_dobra_inicio" name="prev_inicio" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" readonly>
      </div>
      <div>
        <label style="font-weight: bold; color: #666;">Data de Fim</label>
        <input type="date" id="corte_dobra_fim" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f0f0f0;" readonly>
      </div>
    </div>

    <h3 style="color: #059669; margin-bottom: 15px;">‚öôÔ∏è Montagem Eletromecanica</h3>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;">
      <div>
        <label style="font-weight: bold; color: #666;">Data de In√≠cio</label>
        <input type="date" id="montagem_eletro_inicio" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f0f0f0;" readonly>
      </div>
      <div>
        <label style="font-weight: bold; color: #666;">Data de Fim</label>
        <input type="date" id="montagem_eletro_fim" name="prev_fim" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" readonly>
      </div>
    </div>

    <div style="display: flex; gap: 10px;">
      <button type="submit" style="background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; flex: 1;">üíæ Criar OP</button>
      <a href="{{ url_for('ops') }}" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; text-decoration: none; display: flex; align-items: center; justify-content: center; flex: 1;">Cancelar</a>
    </div>

  </form>
</div>

<style>
  input[type="text"],
  input[type="number"],
  input[type="date"],
  select {
    box-sizing: border-box;
  }

  input[type="date"]:focus,
  input[type="text"]:focus,
  input[type="number"]:focus,
  select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  input[type="date"]:readonly {
    background: #f0f0f0;
    cursor: not-allowed;
    color: #333;
  }

  hr {
    margin: 30px 0;
    border: none;
    border-top: 1px solid #ddd;
  }

  h3 {
    font-size: 16px;
    margin-bottom: 15px;
    margin-top: 0;
  }
</style>

<script>
  document.getElementById('obra_select').addEventListener('change', function() {
    const obraId = this.value;
    
    if (!obraId) {
      // Limpar campos se nenhuma obra selecionada
      document.getElementById('produto_select').innerHTML = '<option value="">-- Selecione um produto --</option>';
      document.getElementById('corte_dobra_inicio').value = '';
      document.getElementById('corte_dobra_fim').value = '';
      document.getElementById('montagem_eletro_inicio').value = '';
      document.getElementById('montagem_eletro_fim').value = '';
      document.getElementById('quantidade_input').value = '1';
      return;
    }
    
    // Buscar dados da obra via API
    fetch(`/api/obra/${obraId}`)
      .then(response => response.json())
      .then(data => {
        // Preencher datas
        document.getElementById('corte_dobra_inicio').value = data.corte_dobra_inicio || '';
        document.getElementById('corte_dobra_fim').value = data.corte_dobra_fim || '';
        document.getElementById('montagem_eletro_inicio').value = data.montagem_eletro_inicio || '';
        document.getElementById('montagem_eletro_fim').value = data.montagem_eletro_fim || '';
        
        // Preencher lista de produtos
        const produtoSelect = document.getElementById('produto_select');
        produtoSelect.innerHTML = '<option value="">-- Selecione um produto --</option>';
        
        if (data.produtos && data.produtos.length > 0) {
          data.produtos.forEach(produto => {
            const option = document.createElement('option');
            option.value = produto.nome;
            option.textContent = `${produto.nome} (Qtd: ${produto.quantidade})`;
            produtoSelect.appendChild(option);
          });
          
          // Selecionar primeiro produto automaticamente
          produtoSelect.value = data.produtos[0].nome;
          document.getElementById('quantidade_input').value = data.produtos[0].quantidade;
        }
      })
      .catch(error => console.error('Erro:', error));
  });
  
  // Atualizar quantidade quando produto mudar
  document.getElementById('produto_select').addEventListener('change', function() {
    const obraId = document.getElementById('obra_select').value;
    if (!obraId) return;
    
    fetch(`/api/obra/${obraId}`)
      .then(response => response.json())
      .then(data => {
        const produtoNome = this.value;
        const produto = data.produtos.find(p => p.nome === produtoNome);
        if (produto) {
          document.getElementById('quantidade_input').value = produto.quantidade;
        }
      });
  });
</script>

{% endblock %}
