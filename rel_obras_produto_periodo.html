{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>üìä Relat√≥rio de Obras por Produto e Per√≠odo</h2>
  <p>Visualize as Obras que produzir√£o um produto espec√≠fico em um per√≠odo determinado</p>
</div>

<!-- FILTROS -->
<div class="card">
  <h3>üîç Filtros</h3>
  <form method="POST" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
    
    <div>
      <label for="produto" style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">Produto:</label>
      <select name="produto" id="produto" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="">-- Selecione um produto --</option>
        {% for produto in produtos %}
          <option value="{{ produto.nome }}" {% if produto.nome == produto_selecionado %}selected{% endif %}>
            {{ produto.nome }}
          </option>
        {% endfor %}
      </select>
    </div>
    
    <div>
      <label for="data_inicio" style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">Data In√≠cio:</label>
      <input type="date" name="data_inicio" id="data_inicio" value="{{ data_inicio }}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    
    <div>
      <label for="data_fim" style="display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px;">Data Fim:</label>
      <input type="date" name="data_fim" id="data_fim" value="{{ data_fim }}" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
    
    <div>
      <button type="submit" style="background: #3b82f6; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">Filtrar</button>
    </div>
  </form>
</div>

<!-- RELAT√ìRIO -->
{% if relatorio %}
  {% for item in relatorio %}
    <div class="card">
      <h3>{{ item.produto }}</h3>
      <p style="color: #666; font-size: 13px;">Per√≠odo: <strong>{{ data_inicio }}</strong> a <strong>{{ data_fim }}</strong></p>
      
      <div style="display: flex; gap: 15px; margin-bottom: 20px;">
        <div class="badge">Total de Obras: <strong>{{ item.total_obras }}</strong></div>
      </div>
      
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nome</th>
            <th>Cliente</th>
            <th>Status</th>
            <th>Quantidade</th>
            <th colspan="2" style="text-align: center; background: #fff3cd;">‚úÇÔ∏è Corte/Dobra</th>
            <th colspan="2" style="text-align: center; background: #cfe2ff;">‚öôÔ∏è Montagem Eletromecanica</th>
          </tr>
          <tr>
            <th colspan="5"></th>
            <th style="background: #fff3cd;">In√≠cio</th>
            <th style="background: #fff3cd;">Fim</th>
            <th style="background: #cfe2ff;">In√≠cio</th>
            <th style="background: #cfe2ff;">Fim</th>
          </tr>
        </thead>
        <tbody>
          {% for obra in item.obras %}
            <tr>
              <td><strong>{{ obra.codigo }}</strong></td>
              <td>{{ obra.nome }}</td>
              <td>{{ obra.cliente }}</td>
              <td>
                <span style="
                  display: inline-block;
                  padding: 4px 8px;
                  border-radius: 4px;
                  font-size: 12px;
                  font-weight: bold;
                  {% if obra.status == 'ATIVA' %}
                    background: #e8f5e9; color: #388e3c;
                  {% elif obra.status == 'PAUSADA' %}
                    background: #fff3e0; color: #f57c00;
                  {% elif obra.status == 'CONCLUIDA' %}
                    background: #e3f2fd; color: #1976d2;
                  {% else %}
                    background: #f3f4f6; color: #666;
                  {% endif %}
                ">
                  {{ obra.status }}
                </span>
              </td>
              <td style="font-weight: bold; color: #3b82f6; text-align: center;">{{ obra.quantidade }}</td>
              <td style="background: #fff3cd; text-align: center;">{{ obra.corte_dobra_inicio }}</td>
              <td style="background: #fff3cd; text-align: center;">{{ obra.corte_dobra_fim }}</td>
              <td style="background: #cfe2ff; text-align: center;">{{ obra.montagem_eletro_inicio }}</td>
              <td style="background: #cfe2ff; text-align: center;">{{ obra.montagem_eletro_fim }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}

{% elif produto_selecionado %}
  <div class="card" style="text-align: center; padding: 40px;">
    <p style="color: #999; font-size: 16px;">‚ùå Nenhuma Obra encontrada para o produto <strong>{{ produto_selecionado }}</strong> no per√≠odo selecionado.</p>
  </div>

{% else %}
  <div class="card" style="text-align: center; padding: 40px;">
    <p style="color: #999; font-size: 16px;">üìã Selecione um produto e um per√≠odo para gerar o relat√≥rio.</p>
  </div>
{% endif %}

<style>
  .card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .card h2 {
    margin-top: 0;
    color: #333;
    font-size: 24px;
  }

  .card h3 {
    color: #555;
    font-size: 18px;
    margin-top: 0;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
  }

  .badge {
    background: #f3f4f6;
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 13px;
    color: #666;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 13px;
  }

  th {
    background: #f3f4f6;
    padding: 10px;
    text-align: left;
    font-weight: bold;
    border-bottom: 2px solid #e5e7eb;
  }

  td {
    padding: 10px;
    border-bottom: 1px solid #e5e7eb;
  }

  tr:hover {
    background: #f9fafb;
  }
</style>

<!-- JavaScript para puxar datas automaticamente -->
<script>
  document.getElementById('produto').addEventListener('change', function() {
    const produtoNome = this.value;
    
    if (produtoNome) {
      // Chamar API para puxar datas de Montagem Eletromecanica
      fetch(`/api/produto/${encodeURIComponent(produtoNome)}/datas-eletromecanica`)
        .then(response => response.json())
        .then(data => {
          // Preencher os campos de data automaticamente
          if (data.data_inicio) {
            document.getElementById('data_inicio').value = data.data_inicio;
          }
          if (data.data_fim) {
            document.getElementById('data_fim').value = data.data_fim;
          }
        })
        .catch(error => console.error('Erro ao buscar datas:', error));
    }
  });
</script>

{% endblock %}
