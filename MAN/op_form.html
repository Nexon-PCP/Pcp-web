{% extends "base.html" %}
{% block content %}
<div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
  <div class="card">
    <h2>Nova OP</h2>
    <form method="post" action="{{ url_for('op_criar') }}">
      
      <label>Obra</label><br>
      <select id="obra_id" name="obra_id" required>
        <option value="">-- selecione --</option>
        {% for o in obras %}
          <option value="{{ o.id }}">{{ o.codigo }} - {{ o.nome }}</option>
        {% endfor %}
      </select>

      <br><br>

      <label>Produto</label><br>
      <select id="produto" name="produto" required>
        <option value="">-- selecione a obra primeiro --</option>
      </select>

      <br><br>

      <label>Quantidade</label><br>
      <input name="quantidade" type="number" min="1" value="1" required>

      <br><br>

      <label>Previs√£o de In√≠cio</label><br>
      <input name="prev_inicio" type="date">

      <br><br>

      <label>Previs√£o de T√©rmino</label><br>
      <input name="prev_fim" type="date">

      <br><br>

      <button type="submit">Criar OP</button>
    </form>
    <p style="color: #666; font-size: 12px; margin-top: 20px;">
      <strong>Nota:</strong> O n√∫mero da OP ser√° gerado automaticamente (01, 02, 03...) e as tarefas ter√£o subnumera√ß√£o (1.1, 1.2, 1.3...).
    </p>
  </div>

  <!-- Card com datas da obra -->
  <div class="card" id="obra_info" style="display: none; background: #f0f9ff; border-left: 4px solid #3b82f6;">
    <h3 style="margin-top: 0; color: #1e40af;">üìÖ Datas da Obra</h3>
    <div style="margin-bottom: 15px;">
      <label style="font-size: 12px; font-weight: bold; color: #666;">Data de In√≠cio</label>
      <p id="obra_data_inicio" style="margin: 5px 0; font-size: 16px; font-weight: bold; color: #1e40af;">-</p>
    </div>
    <div>
      <label style="font-size: 12px; font-weight: bold; color: #666;">Data de Fim (Prevista)</label>
      <p id="obra_data_fim" style="margin: 5px 0; font-size: 16px; font-weight: bold; color: #1e40af;">-</p>
    </div>
  </div>
</div>

<script>
document.getElementById("obra_id").addEventListener("change", async function(){
  const obraId = this.value;
  const sel = document.getElementById("produto");
  const obraInfo = document.getElementById("obra_info");
  sel.innerHTML = '<option value="">Carregando...</option>';

  if(!obraId){
    sel.innerHTML = '<option value="">-- selecione a obra primeiro --</option>';
    obraInfo.style.display = 'none';
    return;
  }

  const resp = await fetch(`/api/obra/${obraId}/produtos`);
  const data = await resp.json();

  sel.innerHTML = '<option value="">-- selecione --</option>';
  (data.produtos || []).forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.nome;
    opt.textContent = p.nome;
    sel.appendChild(opt);
  });

  if((data.produtos || []).length === 0){
    sel.innerHTML = '<option value="">(Sem produtos cadastrados nessa obra)</option>';
  }

  // Mostrar datas da obra
  if(data.obra){
    // As datas j√° v√™m formatadas em dd/mm/yyyy
    const dataInicio = data.obra.data_inicio || '-';
    const dataFim = data.obra.prev_fim || '-';
    
    document.getElementById("obra_data_inicio").textContent = dataInicio;
    document.getElementById("obra_data_fim").textContent = dataFim;
    obraInfo.style.display = 'block';
  }
});
</script>
{% endblock %}
